<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dean Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function fetchJSON(url) {
            const res = await fetch(url);
            return await res.json();
        }
        async function postJSON(url, body) {
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            return await res.json();
        }
        let page = 1;
        let pageSize = 50;

        async function loadAnalytics() {
            const params = new URLSearchParams(getFilterParams());
            const data = await fetchJSON(`/dean/analytics?${params.toString()}`);
            if (!data.success) return;
            document.getElementById('total-violations').textContent = data.total;
            renderBarChart('byProgramChart', data.by_program);
            renderPieChart('byGenderChart', data.by_gender);
            renderPieChart('byStatusChart', data.by_status);
        }
        async function loadViolations() {
            const params = new URLSearchParams(getFilterParams());
            params.set('page', page);
            params.set('page_size', pageSize);
            const data = await fetchJSON(`/dean/violations?${params.toString()}`);
            if (!data.success) return;
            const tbody = document.getElementById('violations-body');
            tbody.innerHTML = '';
            data.rows.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${v.violation_id}</td>
                    <td>${v.timestamp || ''}</td>
                    <td>${v.student_id || ''}</td>
                    <td>${v.name || ''}</td>
                    <td>${v.college || ''}</td>
                    <td>${v.course || ''}</td>
                    <td>${v.gender || ''}</td>
                    <td>${v.violation_type || ''}</td>
                    <td><span class="status ${v.status}">${v.status}</span></td>
                    <td>
                        <div class="action-dropdown compact status-${v.status}">
                            <select onchange="updateStatus(${v.violation_id}, this.value)">
                                <option value="">Update...</option>
                                <option value="forwarded_guidance">Forward to Guidance</option>
                                <option value="resolved">Resolved</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('total-count').textContent = data.total;
            document.getElementById('page').textContent = page;
        }
        async function updateStatus(id, val) {
            if (!val) return;
            
            // Find the dropdown element and add loading state
            const dropdown = document.querySelector(`select[onchange*="${id}"]`);
            const dropdownContainer = dropdown?.closest('.action-dropdown');
            
            if (dropdownContainer) {
                dropdownContainer.classList.add('loading');
            }
            
            try {
                const res = await postJSON(`/dean/violation/${id}/status`, { status: val });
                
                if (dropdownContainer) {
                    dropdownContainer.classList.remove('loading');
                    
                    if (res.success) {
                        dropdownContainer.classList.add('success-animation');
                        setTimeout(() => {
                            dropdownContainer.classList.remove('success-animation');
                            loadViolations();
                            loadAnalytics();
                        }, 600);
                    } else {
                        dropdownContainer.classList.add('error-animation');
                        setTimeout(() => {
                            dropdownContainer.classList.remove('error-animation');
                        }, 600);
                        alert(res.error || 'Failed to update');
                    }
                } else {
                    if (res.success) {
                        loadViolations();
                        loadAnalytics();
                    } else {
                        alert(res.error || 'Failed to update');
                    }
                }
            } catch (error) {
                if (dropdownContainer) {
                    dropdownContainer.classList.remove('loading');
                    dropdownContainer.classList.add('error-animation');
                    setTimeout(() => {
                        dropdownContainer.classList.remove('error-animation');
                    }, 600);
                }
                alert('Network error: ' + error.message);
            }
        }
        function getFilterParams() {
            return {
                start: document.getElementById('start').value,
                end: document.getElementById('end').value,
                academic_year: document.getElementById('academic_year').value,
                semester: document.getElementById('semester').value,
                college: '',
                program: document.getElementById('program').value,
                group_by: document.getElementById('group_by').value,
            };
        }
        function applyFilters() { page = 1; loadViolations(); loadAnalytics(); }
        function prevPage() { if (page > 1) { page--; loadViolations(); } }
        function nextPage() { page++; loadViolations(); }

        let charts = {};
        function renderBarChart(id, rows) {
            const ctx = document.getElementById(id).getContext('2d');
            const labels = rows.map(r => r.label);
            const data = rows.map(r => r.cnt);
            charts[id]?.destroy?.();
            charts[id] = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Count', data, backgroundColor: '#4CAF50' }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
        }
        function renderPieChart(id, rows) {
            const ctx = document.getElementById(id).getContext('2d');
            const labels = rows.map(r => r.label);
            const data = rows.map(r => r.cnt);
            charts[id]?.destroy?.();
            charts[id] = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: ['#4CAF50','#FF9800','#03A9F4','#E91E63','#9C27B0','#795548'] }] }, options: { responsive: true } });
        }
        window.addEventListener('DOMContentLoaded', () => { loadViolations(); loadAnalytics(); });
    </script>
</head>
<body>
    <div class="dashboard-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">DEAN</div>
                {% set adm = session.get('admin') %}
                {% if college %}
                <div style="margin-top:6px; font-size:0.9rem; color:#666;">{{ college }}</div>
                {% elif adm and adm.get('college') %}
                <div style="margin-top:6px; font-size:0.9rem; color:#666;">{{ adm.get('college') }}</div>
                {% endif %}
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" data-target="overview-section">Overview</button>
                <button class="nav-item" data-target="statistics-section">Statistics</button>
                <button class="nav-item" data-target="violations-section">Violations</button>
            </nav>
            <div class="sidebar-footer">
                <button class="nav-item muted" id="logout-btn-side">Logout</button>
            </div>
        </aside>

        <main class="main">
        <div class="container">
        <div id="overview-section">
            <div class="metrics-grid">
                <div class="card">
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-label">Total Violations (This Term)</div>
                            <div class="metric-value" id="ov-total">0</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-label">Unresolved</div>
                            <div class="metric-value" id="ov-unresolved">0</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-label">Resolved</div>
                            <div class="metric-value" id="ov-resolved">0</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="metric">
                            <div class="metric-label">Pending > 3 Days</div>
                            <div class="metric-value" id="ov-pending-3d">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Violations Over Time</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="ov-trend" height="160"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Resolved vs Unresolved</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="ov-resolve-pie" height="160"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3>Top College</h3>
                    </div>
                    <div class="card-body">
                        <div id="ov-top-college" class="metric-value" style="font-size:1.2rem;">-</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Top Programs</h3>
                    </div>
                    <div class="card-body">
                        <ul id="ov-top-programs" style="margin:0; padding-left:18px;"></ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Gender Distribution</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="ov-gender" height="140"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div id="statistics-section" style="display:none;">
            <div class="metrics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3>By Status</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="byStatusChart" height="160"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>By Program</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="byProgramChart" height="160"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>By Gender</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="byGenderChart" height="160"></canvas>
                    </div>
                </div>
            </div>
        </div>
    
        <div id="violations-section" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h3>Filters</h3>
                </div>
                <div class="card-body">
                    <div class="dashboard-filters">
                        <input type="date" id="start" placeholder="Start date" class="form-control">
                        <input type="date" id="end" placeholder="End date" class="form-control">
                        <input type="text" id="academic_year" placeholder="Academic Year (e.g., 2024-2025)" class="form-control">
                        <select id="semester" class="form-control">
                            <option value="">Semester</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                        <select id="program" class="form-control">
                            <option value="">All Programs (Your College)</option>
                        </select>
                        <select id="group_by" class="form-control">
                            <option value="day">Day</option>
                            <option value="week">Week</option>
                            <option value="month">Month</option>
                        </select>
                        <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="dashboard-pagination">
                        <div class="pagination-info">
                            <h3>Violation Records</h3>
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-secondary" onclick="prevPage()">Prev</button>
                            <span>Page <span id="page">1</span></span>
                            <button class="btn btn-secondary" onclick="nextPage()">Next</button>
                            <span>Total: <span id="total-count">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Student ID</th>
                                    <th>Name</th>
                                    <th>College</th>
                                    <th>Program</th>
                                    <th>Gender</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="violations-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>
        </main>
        </div>

    <script>
        // Sidebar-only navigation
        document.addEventListener('DOMContentLoaded', async () => {
            const sideButtons = document.querySelectorAll('.sidebar .nav-item');
            function showSection(target){
                sideButtons.forEach(b=>b.classList.toggle('active', b.dataset.target===target));
                document.getElementById('overview-section').style.display = target === 'overview-section' ? '' : 'none';
                document.getElementById('statistics-section').style.display = target === 'statistics-section' ? '' : 'none';
                document.getElementById('violations-section').style.display = target === 'violations-section' ? '' : 'none';
                if (target === 'overview-section') { renderOverview(); }
                if (target === 'statistics-section') { loadAnalytics(); }
            }
            sideButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!btn.dataset.target) return;
                    const target = btn.getAttribute('data-target');
                    showSection(target);
                });
            });
            const logoutSide = document.getElementById('logout-btn-side');
            if (logoutSide) {
                logoutSide.addEventListener('click', async () => {
                    try { await fetch('/logout', { method: 'POST' }); } catch (e) {}
                    window.location.href = '/login';
                });
            }
            // Load programs for this dean's college
            try {
                const res = await fetch('/dean/programs');
                const data = await res.json();
                if (data.success) {
                    const sel = document.getElementById('program');
                    (data.programs || []).forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = p;
                        sel.appendChild(opt);
                    });
                }
            } catch (e) {}
            // Initial render
            renderOverview();
        });

        // Overview rendering using analytics data (reuse OSAS endpoints filtered by college server-side if available)
        async function renderOverview() {
            const params = new URLSearchParams(getFilterParams());
            const data = await fetchJSON(`/dean/analytics?${params.toString()}`);
            if (!data.success) return;
            const total = data.total || 0;
            const byStatus = (data.by_status || []).reduce((acc, r) => { acc[String(r.label||'').toLowerCase()] = r.cnt||0; return acc; }, {});
            const resolved = byStatus['resolved'] || 0;
            const unresolved = total - resolved;
            document.getElementById('ov-total').textContent = total;
            document.getElementById('ov-unresolved').textContent = unresolved;
            document.getElementById('ov-resolved').textContent = resolved;

            const topCollege = (data.by_college || [])[0];
            document.getElementById('ov-top-college').textContent = topCollege ? `${topCollege.label} (${topCollege.cnt})` : '-';
            const topPrograms = (data.by_program || []).slice(0,3);
            const list = document.getElementById('ov-top-programs');
            list.innerHTML = '';
            topPrograms.forEach(p=>{
                const li = document.createElement('li');
                li.textContent = `${p.label} (${p.cnt})`;
                list.appendChild(li);
            });

            const trendGroup = 'day';
            const trend = await fetchJSON(`/dean/trend?${params.toString()}&group_by=${trendGroup}`);
            const trendPayload = { labels: (trend.series || []).map(p=>p.label), rows: (trend.series || []).map(p=>p.cnt) };
            renderLine('ov-trend', trendPayload);
            renderPieChart('ov-resolve-pie', [ { label: 'Resolved', cnt: resolved }, { label: 'Unresolved', cnt: Math.max(0, total - resolved) } ]);
            renderBarChart('ov-gender', data.by_gender || []);
        }

        function renderLine(id, trend){
            const ctx = document.getElementById(id).getContext('2d');
            charts[id]?.destroy?.();
            charts[id] = new Chart(ctx, { type: 'line', data: { labels: trend.labels, datasets: [{ label: 'Violations', data: trend.rows, borderColor: '#007FFF', backgroundColor: 'rgba(0,127,255,0.15)', tension: 0.3 }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
        }
    </script>
</body>
</html>


