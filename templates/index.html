<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Detection with YOLOv8n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 1400px;
        }
        
        .main-content {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .webcam-section {
            flex: 2;
            min-width: 0;
        }
        
        .upload-section {
            flex: 1;
            min-width: 0;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .result-container {
            margin-top: 2rem;
            display: none;
        }
        
        .detection-info {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .image-container {
            text-align: center;
            margin: 1rem 0;
        }
        
        .result-image {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .detection-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
        
        .webcam-container {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 2rem;
            border: 2px solid #e9ecef;
            height: fit-content;
        }
        
        .video-container {
            text-align: center;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
        }
        
        .video-container img {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .webcam-section, .upload-section {
                flex: none;
            }
        }
        
        .webcam-controls {
            margin: 1rem 0;
        }
        
        .webcam-controls .btn {
            margin: 0.25rem;
        }
        
        .detection-status {
            font-size: 1.1rem;
        }
        
        .btn-group .btn.active {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <div class="text-center mb-4">
                <h1 class="display-4 text-primary">
                    <i class="fas fa-user-check me-3"></i>
                    Person Detection & Dress Code Analysis
                </h1>
                <p class="lead text-muted">Real-time person detection, tracking, and dress code analysis using YOLOv8n and Bot-SORT</p>
            </div>
            
            <!-- Main Content Layout -->
            <div class="main-content">
                <!-- Webcam Section (Left - Bigger) -->
                <div class="webcam-section">
                    <div class="section-title">
                        <i class="fas fa-video me-2"></i>Live Webcam Feed
                    </div>
                    <div class="webcam-container">
                        <div class="mb-3">
                            <label for="cameraSelect" class="form-label">Select Camera:</label>
                            <select class="form-select" id="cameraSelect" onchange="changeCamera()">
                                <option value="0">Loading cameras...</option>
                            </select>
                        </div>
                        <div class="video-container mb-3">
                            <img id="videoFeed" src="/video_feed" alt="Video Feed">
                        </div>
                        <div class="webcam-controls text-center">
                            <button class="btn btn-success me-2" id="toggleCameraBtn" onclick="toggleCamera()">
                                <i class="fas fa-video me-2"></i>Turn Off Camera
                            </button>
                            <button class="btn btn-warning me-2" id="toggleDetectionBtn" onclick="toggleDetection()" disabled>
                                <i class="fas fa-eye me-2"></i>Enable Detection
                            </button>
                            <button class="btn btn-info me-2" id="captureBtn" onclick="captureFrame()" disabled>
                                <i class="fas fa-camera me-2"></i>Capture Frame
                            </button>
                            <button class="btn btn-secondary" id="resetTrackerBtn" onclick="resetTracker()" disabled>
                                <i class="fas fa-refresh me-2"></i>Reset Tracker
                            </button>
                        </div>
                        <div class="detection-status mt-3 text-center">
                            <span id="cameraStatus" class="badge bg-success me-2">Camera: On</span>
                            <span id="detectionStatus" class="badge bg-secondary">Detection: Disabled</span>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Section (Right - Smaller) -->
                <div class="upload-section">
                    <div class="section-title">
                        <i class="fas fa-upload me-2"></i>Upload Image
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-3"></i>
                        <h5>Drag & Drop Image Here</h5>
                        <p class="text-muted small">or click to browse files</p>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <div class="mt-3">
                            <button class="btn btn-custom btn-sm" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-2"></i>Choose File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="mt-3 text-muted">Processing image...</p>
            </div>
            
            <div class="result-container" id="resultContainer">
                <div class="detection-info">
                    <h5><i class="fas fa-info-circle me-2"></i>Detection Results</h5>
                    <div class="detection-count" id="detectionCount">0 persons detected</div>
                    <div id="detectionDetails"></div>
                </div>
                
                <div class="image-container">
                    <img id="resultImage" class="result-image" alt="Detection Result">
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-custom" onclick="resetUpload()">
                        <i class="fas fa-redo me-2"></i>Upload Another Image
                    </button>
                </div>
            </div>
            
            <div class="alert alert-info alert-custom mt-4">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips:</h6>
                <ul class="mb-0">
                    <li>Supported formats: JPG, PNG, GIF, BMP</li>
                    <li>For best results, use clear images with good lighting</li>
                    <li>Detection confidence threshold: 50%</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('resultContainer');
        const detectionCount = document.getElementById('detectionCount');
        const detectionDetails = document.getElementById('detectionDetails');
        const resultImage = document.getElementById('resultImage');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Show loading
            loading.style.display = 'block';
            resultContainer.style.display = 'none';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.success) {
                    displayResults(data);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                alert('Error uploading file: ' + error.message);
            });
        }

        function displayResults(data) {
            // Update detection count
            const count = data.count;
            detectionCount.textContent = `${count} person${count !== 1 ? 's' : ''} detected`;

            // Display detection details
            if (data.detections.length > 0) {
                let detailsHtml = '<div class="mt-2"><strong>Detection Details:</strong><ul class="mt-2">';
                data.detections.forEach((detection, index) => {
                    const trackId = detection.track_id ? `ID: ${detection.track_id}` : 'No ID';
                    const dressSummary = detection.dress_summary || 'No dress items detected';
                    detailsHtml += `<li>Person ${index + 1} (${trackId}): Confidence ${(detection.confidence * 100).toFixed(1)}%<br>
                                   <small class="text-muted">Dress Items: ${dressSummary}</small></li>`;
                });
                detailsHtml += '</ul></div>';
                detectionDetails.innerHTML = detailsHtml;
            } else {
                detectionDetails.innerHTML = '<p class="text-muted mt-2">No persons detected in the image.</p>';
            }

            // Display result image
            resultImage.src = 'data:image/jpeg;base64,' + data.image;
            
            // Show results
            resultContainer.style.display = 'block';
        }

        function resetUpload() {
            resultContainer.style.display = 'none';
            fileInput.value = '';
        }

        // Reset tracker function
        function resetTracker() {
            fetch('/reset_tracker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Tracker reset successfully! All tracking IDs have been cleared.');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error resetting tracker: ' + error.message);
            });
        }

        // Load available cameras
        function loadCameras() {
            fetch('/get_cameras')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const cameraSelect = document.getElementById('cameraSelect');
                        cameraSelect.innerHTML = '';
                        
                        if (data.cameras.length > 0) {
                            data.cameras.forEach(camera => {
                                const option = document.createElement('option');
                                option.value = camera.id;
                                option.textContent = camera.name;
                                cameraSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = '0';
                            option.textContent = 'No cameras found';
                            cameraSelect.appendChild(option);
                        }
                    } else {
                        console.error('Error loading cameras:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                });
        }

        // Change camera function
        function changeCamera() {
            const cameraSelect = document.getElementById('cameraSelect');
            const selectedCameraId = parseInt(cameraSelect.value);
            
            fetch('/change_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id: selectedCameraId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update camera status
                    document.getElementById('cameraStatus').textContent = `Camera: On (${selectedCameraId})`;
                    document.getElementById('cameraStatus').className = 'badge bg-success me-2';
                    
                    // Reset detection status
                    document.getElementById('detectionStatus').textContent = 'Detection: Disabled';
                    document.getElementById('detectionStatus').className = 'badge bg-secondary';
                    
                    // Refresh video feed
                    document.getElementById('videoFeed').src = '/video_feed?' + new Date().getTime();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error changing camera: ' + error.message);
            });
        }

        // Auto-start camera when page loads
        window.addEventListener('load', function() {
            loadCameras();
            // Wait a bit for cameras to load, then start camera
            setTimeout(() => {
                startCamera();
            }, 500);
        });

        // Webcam functions
        function startCamera() {
            const cameraSelect = document.getElementById('cameraSelect');
            const selectedCameraId = cameraSelect ? parseInt(cameraSelect.value) : 0;
            
            fetch('/start_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id: selectedCameraId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Enable all buttons since camera is now running
                    document.getElementById('toggleDetectionBtn').disabled = false;
                    document.getElementById('captureBtn').disabled = false;
                    document.getElementById('resetTrackerBtn').disabled = false;
                    // Update camera status
                    document.getElementById('cameraStatus').textContent = `Camera: On (${selectedCameraId})`;
                    document.getElementById('cameraStatus').className = 'badge bg-success me-2';
                    // Update toggle button
                    const toggleBtn = document.getElementById('toggleCameraBtn');
                    toggleBtn.innerHTML = '<i class="fas fa-video-slash me-2"></i>Turn Off Camera';
                    toggleBtn.className = 'btn btn-danger me-2';
                    // Refresh video feed
                    document.getElementById('videoFeed').src = '/video_feed?' + new Date().getTime();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error starting camera: ' + error.message);
            });
        }

        function stopCamera() {
            fetch('/stop_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Disable all buttons since camera is now off
                    document.getElementById('toggleDetectionBtn').disabled = true;
                    document.getElementById('captureBtn').disabled = true;
                    document.getElementById('resetTrackerBtn').disabled = true;
                    // Update camera status
                    document.getElementById('cameraStatus').textContent = 'Camera: Off';
                    document.getElementById('cameraStatus').className = 'badge bg-danger me-2';
                    // Update toggle button
                    const toggleBtn = document.getElementById('toggleCameraBtn');
                    toggleBtn.innerHTML = '<i class="fas fa-video me-2"></i>Turn On Camera';
                    toggleBtn.className = 'btn btn-success me-2';
                    // Reset detection status
                    document.getElementById('detectionStatus').textContent = 'Detection: Disabled';
                    document.getElementById('detectionStatus').className = 'badge bg-secondary';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error stopping camera: ' + error.message);
            });
        }

        function toggleCamera() {
            const cameraStatus = document.getElementById('cameraStatus').textContent;
            if (cameraStatus === 'Camera: On') {
                stopCamera();
            } else {
                startCamera();
            }
        }

        function toggleDetection() {
            fetch('/toggle_detection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const statusElement = document.getElementById('detectionStatus');
                    const toggleBtn = document.getElementById('toggleDetectionBtn');
                    
                    if (data.detection_enabled) {
                        statusElement.textContent = 'Detection: Enabled';
                        statusElement.className = 'badge bg-success';
                        toggleBtn.innerHTML = '<i class="fas fa-eye-slash me-2"></i>Disable Detection';
                        toggleBtn.className = 'btn btn-danger me-2';
                    } else {
                        statusElement.textContent = 'Detection: Disabled';
                        statusElement.className = 'badge bg-secondary';
                        toggleBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Enable Detection';
                        toggleBtn.className = 'btn btn-warning me-2';
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error toggling detection: ' + error.message);
            });
        }

        function captureFrame() {
            fetch('/capture_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display captured frame results
                    displayResults(data);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error capturing frame: ' + error.message);
            });
        }
    </script>
</body>
</html>
