<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dress Code Detection System</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">System Status</div>
                <div class="status-value" id="system-status">Online</div>
            </div>
            <div class="status-divider"></div>
            <div class="status-item">
                <div class="status-label">Camera Status</div>
                <div class="status-value" id="camera-status">Inactive</div>
            </div>
            <div class="status-divider"></div>
            <div class="status-item">
                <div class="status-label">RFID Scanner</div>
                <div class="status-value" id="rfid-status-overview">Ready</div>
            </div>
            <div class="status-divider"></div>
            <div class="status-item">
                <div class="status-label">Detection Mode</div>
                <div class="status-value" id="detection-mode">Live</div>
            </div>
        </div>
            
        <!-- Live Monitoring Section -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-video"></i>Live Camera Feed</h2>
            </div>
            <div class="monitoring-layout">
                <div class="webcam-section">
                        <div class="video-container">
                            <img id="videoFeed" src="/video_feed" alt="Video Feed" class="loading" style="display: none;">
                            <div id="cameraOffOverlay" class="camera-off-overlay" style="display: flex;">
                                <div class="camera-off-content">
                                    <i class="fas fa-video-slash fa-4x mb-3"></i>
                                    <h4>Camera Turned Off</h4>
                                    <p class="small">Click "Turn On Camera" to resume live feed</p>
                                </div>
                            </div>
                        <div id="cameraOffSign" class="camera-off-sign" style="display: block;">
                            <div class="camera-off-indicator">
                                <i class="fas fa-video-slash"></i>
                                <span>CAMERA OFF</span>
                            </div>
                        </div>
                        <div id="cameraInitializingSign" class="camera-initializing-sign" style="display: none;">
                            <div class="camera-initializing-indicator">
                                <i class="fas fa-spinner camera-spinner"></i>
                                <span>INITIALIZING...</span>
                                </div>
                            </div>
                        </div>
                        <div class="webcam-controls" role="group" aria-label="Camera controls">
                        <div style="display: flex; gap: 8px; align-items: center; justify-content: center; flex-wrap: nowrap;">
                            <select id="cameraSelect" class="form-control" style="min-width: 120px; max-width: 150px;">
                                <option value="0">Loading cameras...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadAvailableCameras()" title="Refresh camera list">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-success" id="toggleCameraBtn" onclick="toggleCamera()">
                                <i class="fas fa-video"></i>Turn On Camera
                            </button>
                            <button class="btn btn-secondary" id="resetTrackerBtn" onclick="resetTracker()" disabled>
                                <i class="fas fa-refresh"></i>Reset Tracker
                            </button>
                            <button class="btn btn-info" id="testModeBtn" onclick="toggleTestMode()">
                                <i class="fas fa-flask"></i>Test Mode
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="rfid-section">
                    <div class="rfid-header">
                        <h3><i class="fas fa-id-card"></i>RFID Scanner</h3>
                        </div>
                        <div class="rfid-status">
                            <span id="rfidStatus" class="badge bg-secondary">
                                <i class="fas fa-clock"></i>RFID: Waiting
                            </span>
                            <div id="testModeStatus" class="test-mode-indicator" style="display: none;">
                                <span class="badge bg-warning">
                                    <i class="fas fa-flask"></i>Test Mode Active
                                </span>
                            </div>
                        </div>
                        
                        <div id="rfidDataDisplay" class="alert alert-info" style="display: none;">
                            <div class="mb-3">
                                <strong>
                                    <i class="fas fa-credit-card"></i>Current Card
                                </strong>
                            </div>
                            <div class="rfid-data-content">
                                <div>
                                    <strong><i class="fas fa-fingerprint"></i>UID:</strong>
                                    <span id="rfidUid" class="font-monospace">N/A</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-tag"></i>Type:</strong>
                                    <span id="rfidType">Mifare Classic 1K</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-user"></i>Name:</strong>
                                    <span id="studentName">-</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-id-card"></i>Student ID:</strong>
                                    <span id="studentId">-</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-venus-mars"></i>Gender:</strong>
                                    <span id="studentGender">-</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-book"></i>Program:</strong>
                                    <span id="studentCourse">-</span>
                                </div>
                                <div>
                                    <strong><i class="fas fa-university"></i>College:</strong>
                                    <span id="studentCollege">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <script>
        // Load available cameras on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableCameras();
        });

        // Function to load available cameras
        function loadAvailableCameras() {
            const cameraSelect = document.getElementById('cameraSelect');
            cameraSelect.innerHTML = '<option value="0">Loading cameras...</option>';
            cameraSelect.disabled = true;
            
            fetch('/get_cameras')
                .then(response => response.json())
                .then(data => {
                    cameraSelect.innerHTML = '';
                    
                    if (data.success && data.cameras && data.cameras.length > 0) {
                        data.cameras.forEach((camera, index) => {
                            const option = document.createElement('option');
                            option.value = camera.id;
                            
                            // Create more descriptive text
                            let displayText = camera.name;
                            if (camera.fps && camera.fps > 0) {
                                displayText += ` @ ${Math.round(camera.fps)}fps`;
                            }
                            
                            option.textContent = displayText;
                            option.title = `Resolution: ${camera.resolution}${camera.backend ? ` | Backend: ${camera.backend}` : ''}`;
                            cameraSelect.appendChild(option);
                        });
                        
                        // Show success message briefly
                        console.log(`Loaded ${data.cameras.length} camera(s)`);
                    } else {
                        // Fallback if no cameras detected
                        const option = document.createElement('option');
                        option.value = 0;
                        option.textContent = 'No cameras detected';
                        cameraSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                    cameraSelect.innerHTML = '<option value="0">Error loading cameras</option>';
                })
                .finally(() => {
                    cameraSelect.disabled = false;
                    
                    // Add event listener for camera selection change
                    cameraSelect.addEventListener('change', function() {
                        const selectedCameraId = parseInt(this.value);
                        if (selectedCameraId >= 0) {
                            // Automatically start the selected camera
                            switchToCamera(selectedCameraId);
                        }
                    });
                });
        }

        // Function to switch to a different camera and automatically start it
        function switchToCamera(cameraId) {
            // Show initializing sign
            const initializingSign = document.getElementById('cameraInitializingSign');
            initializingSign.style.display = 'block';
            
            // Hide camera off sign
            const offSign = document.getElementById('cameraOffSign');
            offSign.style.display = 'none';
            
            fetch('/change_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id: cameraId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const toggleBtn = document.getElementById('toggleCameraBtn');
                    toggleBtn.innerHTML = '<i class="fas fa-video-slash me-2"></i>Turn Off Camera';
                    toggleBtn.className = 'btn btn-danger';
                    
                    // Refresh video feed and show it
                    const videoFeed = document.getElementById('videoFeed');
                    videoFeed.src = '/video_feed?' + new Date().getTime();
                    videoFeed.style.display = 'block';
                    videoFeed.classList.remove('loading');
                    
                    // Hide camera off overlay
                    const overlay = document.getElementById('cameraOffOverlay');
                    overlay.style.display = 'none';
                    overlay.classList.remove('show');
                    
                    // Hide camera off sign
                    const sign = document.getElementById('cameraOffSign');
                    sign.style.display = 'none';
                    
                    // Hide initializing sign
                    initializingSign.style.display = 'none';
                    
                    // Update overview metrics
                    document.getElementById('camera-status').textContent = 'Active';
                    
                    console.log(`Switched to camera ${cameraId} successfully`);
                } else {
                    alert('Error switching camera: ' + data.message);
                    // Hide initializing sign on error
                    initializingSign.style.display = 'none';
                }
            })
            .catch(error => {
                alert('Error switching camera: ' + error.message);
                // Hide initializing sign on error
                initializingSign.style.display = 'none';
            });
        }

        // Camera functions
        function startCamera() {
            const cameraSelect = document.getElementById('cameraSelect');
            const selectedCameraId = cameraSelect ? parseInt(cameraSelect.value) : 0;
            
            // Show initializing sign
            const initializingSign = document.getElementById('cameraInitializingSign');
            initializingSign.style.display = 'block';
            
            // Hide camera off sign
            const offSign = document.getElementById('cameraOffSign');
            offSign.style.display = 'none';
            
            fetch('/start_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ camera_id: selectedCameraId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Enable reset tracker button since camera is now running
                    document.getElementById('resetTrackerBtn').disabled = false;
                    // Update toggle button
                    const toggleBtn = document.getElementById('toggleCameraBtn');
                    toggleBtn.innerHTML = '<i class="fas fa-video-slash"></i>Turn Off Camera';
                    toggleBtn.className = 'btn btn-danger';
                    // Refresh video feed and show it
                    const videoFeed = document.getElementById('videoFeed');
                    videoFeed.src = '/video_feed?' + new Date().getTime();
                    videoFeed.style.display = 'block';
                    // Remove loading animation
                    videoFeed.classList.remove('loading');
                    // Hide camera off overlay
                    const overlay = document.getElementById('cameraOffOverlay');
                    overlay.style.display = 'none';
                    overlay.classList.remove('show');
                    
                    // Hide camera off sign
                    const sign = document.getElementById('cameraOffSign');
                    sign.style.display = 'none';
                    
                    // Hide initializing sign
                    const initializingSign = document.getElementById('cameraInitializingSign');
                    initializingSign.style.display = 'none';
                    
                    // Update overview metrics
                    document.getElementById('camera-status').textContent = 'Active';
                } else {
                    alert('Error: ' + data.message);
                    // Hide initializing sign on error
                    const initializingSign = document.getElementById('cameraInitializingSign');
                    initializingSign.style.display = 'none';
                }
            })
            .catch(error => {
                alert('Error starting camera: ' + error.message);
                // Hide initializing sign on error
                const initializingSign = document.getElementById('cameraInitializingSign');
                initializingSign.style.display = 'none';
            });
        }

        function stopCamera() {
            fetch('/stop_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Disable reset tracker button since camera is now off
                    document.getElementById('resetTrackerBtn').disabled = true;
                    // Update toggle button
                    const toggleBtn = document.getElementById('toggleCameraBtn');
                    toggleBtn.innerHTML = '<i class="fas fa-video"></i>Turn On Camera';
                    toggleBtn.className = 'btn btn-success';
                    // Clear video feed and hide it
                    const videoFeed = document.getElementById('videoFeed');
                    videoFeed.src = '';
                    videoFeed.style.display = 'none';
                    
                    // Show camera off overlay
                    const overlay = document.getElementById('cameraOffOverlay');
                    overlay.style.display = 'flex';
                    overlay.classList.add('show');
                    
                    // Show camera off sign
                    const sign = document.getElementById('cameraOffSign');
                    sign.style.display = 'block';
                    
                    // Update overview metrics
                    document.getElementById('camera-status').textContent = 'Inactive';
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error stopping camera: ' + error.message);
            });
        }

        function toggleCamera() {
            const toggleBtn = document.getElementById('toggleCameraBtn');
            const buttonText = toggleBtn.innerHTML;
            
            if (buttonText.includes('Turn Off Camera')) {
                stopCamera();
            } else {
                startCamera();
            }
        }

        function resetTracker() {
            fetch('/reset_tracker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Tracker reset successfully');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error resetting tracker: ' + error.message);
            });
        }

        // Test Mode Functions
        let testModeActive = false;

        function toggleTestMode() {
            testModeActive = !testModeActive;
            const testModeBtn = document.getElementById('testModeBtn');
            const testModeStatus = document.getElementById('testModeStatus');
            
            if (testModeActive) {
                testModeBtn.innerHTML = '<i class="fas fa-flask"></i>Exit Test Mode';
                testModeBtn.className = 'btn btn-warning';
                testModeStatus.style.display = 'block';
                
                // Update overview metrics
                document.getElementById('detection-mode').textContent = 'Test';
                
                // Send test mode activation to server
                fetch('/toggle_test_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test_mode: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Test mode activated');
                    }
                })
                .catch(error => {
                    console.error('Error activating test mode:', error);
                });
            } else {
                testModeBtn.innerHTML = '<i class="fas fa-flask"></i>Test Mode';
                testModeBtn.className = 'btn btn-info';
                testModeStatus.style.display = 'none';
                
                // Update overview metrics
                document.getElementById('detection-mode').textContent = 'Live';
                
                // Send test mode deactivation to server
                fetch('/toggle_test_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ test_mode: false })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Test mode deactivated');
                    }
                })
                .catch(error => {
                    console.error('Error deactivating test mode:', error);
                });
            }
        }

        // RFID Functions
        function updateRfidDisplay(uid, cardType, student) {
            const display = document.getElementById('rfidDataDisplay');
            const uidElement = document.getElementById('rfidUid');
            const typeElement = document.getElementById('rfidType');
            const nameEl = document.getElementById('studentName');
            const idEl = document.getElementById('studentId');
            const genderEl = document.getElementById('studentGender');
            const courseEl = document.getElementById('studentCourse');
            const collegeEl = document.getElementById('studentCollege');
            
            if (uid) {
                uidElement.textContent = uid;
                typeElement.textContent = cardType;
                display.style.display = 'block';
                if (student) {
                    nameEl.textContent = student.name || '-';
                    idEl.textContent = student.student_id || '-';
                    genderEl.textContent = student.gender || '-';
                    courseEl.textContent = student.course || '-';
                    collegeEl.textContent = student.college || '-';
                } else {
                    nameEl.textContent = '-';
                    idEl.textContent = '-';
                    genderEl.textContent = '-';
                    courseEl.textContent = '-';
                    collegeEl.textContent = '-';
                }
            }
        }

        function hideRfidDisplay() {
            const display = document.getElementById('rfidDataDisplay');
            display.style.display = 'none';
        }

        // Initialize page when loaded
        window.addEventListener('load', function() {
            // Check RFID status every 2 seconds
            setInterval(checkRfidStatus, 2000);
        });

        // RFID Functions
        function checkRfidStatus() {
            fetch('/rfid/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                        const status = data.status;
                        const rfidStatus = document.getElementById('rfidStatus');
                        
                        // Update RFID status
                        if (status.present) {
                            rfidStatus.innerHTML = '<i class="fas fa-check-circle"></i>RFID: Active (' + status.last_uid + ')';
                            rfidStatus.className = 'badge bg-success';
                            
                            // Update overview metrics
                            document.getElementById('rfid-status-overview').textContent = 'Active';
                            
                            // Update RFID display with student data when present
                            updateRfidDisplay(status.last_uid, 'Mifare Classic 1K', status.student || null);
                } else {
                            rfidStatus.innerHTML = '<i class="fas fa-clock"></i>RFID: Waiting';
                            rfidStatus.className = 'badge bg-secondary';
                            
                            // Update overview metrics
                            document.getElementById('rfid-status-overview').textContent = 'Ready';
                            
                            // Hide RFID display
                            hideRfidDisplay();
                        }
                }
            })
            .catch(error => {
                    console.error('Error checking RFID status:', error);
            });
        }
    </script>
</body>
</html>
